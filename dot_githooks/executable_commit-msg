#!/bin/bash

CONFIG_FILE="$(git rev-parse --show-toplevel)/.commit-rules"
# PROTECTED_PATHS="^prod/"  # default

if [[ -f "$CONFIG_FILE" ]]; then
  PROTECTED_PATHS=$(grep '^protected_paths=' "$CONFIG_FILE" | cut -d= -f2)
fi

[[ -z "$PROTECTED_PATHS" ]] && exit 0

if git diff --cached --name-only | grep -qE "$PROTECTED_PATHS"; then
  if ! grep -qE '[A-Z]+-[0-9]+' "$1"; then
    echo "ERROR: Commits touching protected paths must include a Jira ticket"
    exit 1
  fi
fi